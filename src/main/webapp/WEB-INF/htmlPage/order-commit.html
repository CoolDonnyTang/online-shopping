<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->

<title>爱购商城</title>

<!-- Bootstrap -->
<link href="../resources/plugins/bootstrap/css/bootstrap.min.css"
	rel="stylesheet">
<link href="../resources/my-css/shopping-cart.css" rel="stylesheet">
<link href="../resources/my-css/index.css" rel="stylesheet">
<link href="../resources/my-css/user-base.css" rel="stylesheet">
</head>
<body>
	<div class="page-header">
		<div class="container">
			<div class="row">
				<div class="col-md-2 heaer-menu">
					<a class="header-link" href="login.html">请登录</a>&nbsp;&nbsp;&nbsp;
					<a class="header-link" href="register.html">免费注册</a>
				</div>
				<div class="col-md-7"></div>
				<div class="col-md-1 heaer-menu">
					<div class="dropdown">
						<a id="dLabel1" data-target="#" href="#"
							data-toggle="dropdown" role="button" aria-haspopup="true"
							aria-expanded="false" class="header-link"> 我的爱购 <span
							class="caret"></span>
						</a>
						<ul class="dropdown-menu" aria-labelledby="dLabel1">
							<li><a class="link-hover">我的订单</a></li>
							<li><a class="link-hover">我的关注</a></li>
						</ul>
					</div>
				</div>
				<div class="col-md-1 heaer-menu">
					<div>
						<a href="login/shopping-cart.action" class="header-link">我的购物车 </a>
					</div>
				</div>
				<div class="col-md-1 heaer-menu">
					<div class="dropdown">
						<a id="dLabel3" data-target="#" href="http://example.com"
							data-toggle="dropdown" role="button" aria-haspopup="true"
							aria-expanded="false" class="header-link">联系客服 <span
							class="caret"></span>
						</a>
						<ul class="dropdown-menu" aria-labelledby="dLabel3">
							<li>028-12345678</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="container">
		<!--结算主体隐藏区开始-->
		<div>
			<div class="row cart-header">
				<div class="col-md-3 s-cart padding-lr0">
					<div class="col-md-6 padding-lr0">
						<a href="../index.html" class="thumbnail activity-link"> <img
							src="../resources/images/logo.png" class="logo">
						</a>
					</div>
					结算
				</div>
			</div>
			<!-- 收货地址开始 -->
			<div class="addr-container">
				<div class="address-header">
					<span><b>收货人信息</b></span>
					<button type="button" class="btn btn-default btn-xs my-btn-1" id="addNewAddr">添加新地址</button>
				</div>
				<div class="adrres-list">
					<ul id="addrList">
						<li><input type="radio" name="addr-list" class="addr-list-c"
							checked="checked">唐晏忍 四川 成都市 高新西区 百叶路1号（电子科技大学成都学院）
							181****1400</li>
						<li><input type="radio" name="addr-list" class="addr-list-c">唐晏忍
							四川 成都市 高新西区 百叶路1号（电子科技大学成都学院） 181****1400</li>
						<li><input type="radio" name="addr-list" class="addr-list-c">唐晏忍
							四川 成都市 高新西区 百叶路1号（电子科技大学成都学院） 181****1400</li>
						<li><input type="radio" name="addr-list" class="addr-list-c">唐晏忍
							四川 成都市 高新西区 百叶路1号（电子科技大学成都学院） 181****1400</li>
						<li><input type="radio" name="addr-list" class="addr-list-c">唐晏忍
							四川 成都市 高新西区 百叶路1号（电子科技大学成都学院） 181****1400</li>
						<li><input type="radio" name="addr-list" class="addr-list-c">唐晏忍
							四川 成都市 高新西区 百叶路1号（电子科技大学成都学院） 181****1400</li>
					</ul>
					<div class="col-sm-12" id="addrMessage" style="display: none;">
						<form class="form-horizontal" id="addrForm">
							<div class="form-group">
								<label for="inputName" class="col-sm-2 control-label">收件人:</label>
								<div class="col-sm-10">
									<input type="text" class="form-control" id="inputName"
										placeholder="姓名" name="recipient">
								</div>
							</div>
							<div class="form-group">
								<label for="inputNumber" class="col-sm-2 control-label">手机号:</label>
								<div class="col-sm-10">
									<input type="text" class="form-control" id="inputNumber"
										placeholder="号码" name="mobileNumber">
								</div>
							</div>
							<div class="form-group">
								<label for="inputAddr" class="col-sm-2 control-label">收货地址:</label>
								<div class="col-sm-10">
									<input type="text" class="form-control" id="inputAddr"
										placeholder="地址" name="address">
								</div>
							</div>
							<button type="button" class="btn btn-danger btn-xs" id="commitAddr">保存</button>
						</form>
					</div>
				</div>
			</div>
			<!-- 收货地址结束 -->
			<!-- 支付方式开始 -->
			<div class="addr-container">
				<div class="address-header">
					<span><b>支付方式</b></span>
				</div>
				<div class="payment" id="payment">
					<ul>
						<li><input type="radio" name="pay-list" class="addr-list-c"
							checked="checked" value="0">货到付款</li>
						<li><input type="radio" name="pay-list" class="addr-list-c" value="1">支付宝支付</li>
					</ul>
				</div>
			</div>
			<!-- 支付方式结束 -->

			<!-- 商品清单开始 -->
			<div class="addr-container">
				<div class="address-header">
					<span><b>商品清单</b></span>
				</div>
				<div class="table-responsive">
					<table class="table cart-table" id="commEnList">
						<tr>
							<td>
								<div class="media cart-commodity">
									<div class="media-left media-middle">
										<img class="media-object cart-image"
											src="../resources/images/head-portrait.png">
									</div>
									<div class="media-body comment">
										<p>爱购联系保修，享受法定凭质保证书及爱购商城发票，可享受全国联保服务</p>
										<div class="attribute_">
											<span>土豪版&nbsp;</span> <span>32寸&nbsp;</span>
										</div>
									</div>
								</div>
							</td>
							<td><b>￥320.00</b></td>
							<td>x1</td>
							<td>库存 1233</td>
						</tr>
					</table>
				</div>
			</div>
			<!-- 商品清单结束 -->
			<!-- 警告信息 -->
			<div class="col-sm-12 col-md-12 disMessage-container">
				<div class="alert alert-danger" role="alert" id="disMessage" style="display: none;">测试</div>
			</div>
			<div class="cart-operate col-md-12">
				<div class="col-md-3">
					<button type="button" class="btn btn-default btn-xs my-btn-1" id="gotoShoppingCart">返回购物车修改</button>
				</div>
				<div class="col-md-2 col-md-offset-6">
					订单金额：<span class="total-money"><b id="totalPrice">￥12333</b></span>
				</div>
				<button type="button" class="btn btn-danger col-md-1" id="commitOrder">提交订单</button>
			</div>
		</div>
		<!--结算主体隐藏区结束-->
	</div>


	<hr />
	<div class="page-footer-body text-center">
		<ul class="footer-list">
			<li>关于我们</li>
			<li>联系我们</li>
			<li>亲情加盟</li>
			<li>商城社区</li>
			<li>我在中国</li>
			<li>友情链接</li>
		</ul>
	</div>
	<div class="page-copyright text-center">
		Copyright &copy; 2017 <strong>爱购商城i-go.shop</strong> 版权所有
	</div>
	<script src="../resources/plugins/jquery-2.2.4.min.js"></script>
	<script src="../resources/plugins/bootstrap/js/bootstrap.min.js"></script>
	<script src="../resources/scripts/my-utils.js"></script>
	<script src="../resources/scripts/order-commit.js"></script>
	<script src="../resources/scripts/my-ajax.js"></script>
	<script type="text/javascript"
		src="//at.alicdn.com/t/font_zcsipz08mj0b2o6r.js"></script>
	<script type="text/javascript">
		$(function() {
			//获取当前url参数
			var param = window.atob(window.location.search.replace("?", ""));
			var parmArray = param.split("&");
			var commEntitiesId = new Array(parmArray.length);
			for (var j = 0; j < parmArray.length; j++) {
				commEntitiesId[j] = parseInt(parmArray[j].split("|")[0]);
			}
			
			//加载收货地址
			loadAddr();
			
			//发送请求加载商品数据
			$.ajax({
				data : {commEntitiesId:commEntitiesId},
				dataType : "json",
				error : function() {

				},
				success : function(result) {
					if (result.status === 1) {
						var data = result.data;
						//清空列表
						$("#commEnList tr").remove();
						//总价
						var totalPrice = 0;
						for (var i = 0; i < data.length; i++) {
							var amount;
							for (var k = 0; k < parmArray.length; k++) {
								if (data[i].commEntityId === parseInt(parmArray[k]
										.split("|")[0])) {
									amount = parmArray[k].split("|")[1];
								}
							}
							//console.log(result);
							var $trNode = $("<tr>"
									+ "<td>"
									+ "<div class='media cart-commodity'>"
									+ "<div class='media-left media-middle'>"
									+ "<img class='media-object cart-image' src='"+ data[i].mainUrl +"'>"
									+ "</div>"
									+ "<div class='media-body comment'>"
									+ "<p><b>"
									+ data[i].commTitle
									+ "</b></p>"
									+ "<div class='attribute_'>"
									+ "<span>"
									+ data[i].commBrand
									+ ": "
									+ data[i].prop1
									+ data[i].prop2
									+ "</span>"
									+ "</div>"
									+ "</div>"
									+ "</div>"
									+ "</td>"
									+ "<td><b>￥"
									+ data[i].price
									+ "</b></td>"
									+ "<td>x"
									+ amount
									+ "</td>"
									+ "<td>库存 "
									+ data[i].inventory
									+ "</td>" + "</tr>");
							totalPrice = totalPrice + data[i].price * amount;
							$trNode.data("commEntityId", data[i].commEntityId);
							$trNode.data("amount", amount);
							$("#commEnList").append($trNode);
						}
						$("#totalPrice").text("￥"+totalPrice);
					}
				},
				type : "post",
				url : "../checkLogin/findCommEntitiesById.action"
			});
			//新建地址按钮点击事件
			$("#addNewAddr").click(function(){
				$("#addrList").hide();
				$("#addrMessage").show();
			});
			//保存新建地址'保存'按钮事件
			$("#commitAddr").click(function(){
				var data = new FormData($("#addrForm").get(0));
				//发送请求保存数据
				$.ajax({
					data : data,
					dataType : "json",
					cache: false,
		            contentType: false,    //不可缺
		            processData: false,    //不可缺
					error : function() {
					
					},
					success : function(result) {
						if (result.status === 1) {
							$("#addrList").show();
							$("#addrMessage").hide();
							//加载收货地址
							loadAddr();
						} else {
							console.log("failed");
						}
					},
					type : "post",
					url : "../checkLogin/addShippingAddr.action"
				});
			});
			//点击返回购物车
			$("#gotoShoppingCart").click(function(){
				window.location.href = "../login/shopping-cart.action"; 
			});
			
			//点击提交按钮提交订单
			$("#commitOrder").click(function(){
				//获取地址id
				var addrId = $("#addrList input:checked").parents("li").data("addrId");
				var entityIdAndAmount = [];
				//所有商品tr
				var $tr = $("#commEnList tr");
				//支付方式
				var payment = $("#payment input:checked").val();
				for(var i=0; i<$tr.length; i++) {
					entityIdAndAmount.push("commEntityId="+$tr.eq(i).data("commEntityId") + "&amount=" +$tr.eq(i).data("amount"))
				}
				console.log(entityIdAndAmount);
				//发送请求提交订单数据
				$.ajax({
					data : {addrId:addrId, entityIdAndAmount:entityIdAndAmount,payment:payment},
					dataType : "json",
					error : function() {
						
					},
					success : function(result) {
						if (result.status === 1) {
							console.log(result);
							var data = result.data;
							var orderIdParam = window.btoa("orderId="+data.id);
							if(data.payment === "货到付款") {
								window.location.href = "../login/orderDetail.action?"+orderIdParam;
							}
						} else if(result.status === 0) {
							$("#disMessage").show();
							$("#disMessage").text(result.info);
						}
					},
					type : "post",
					url : "../checkLogin/commitOrder.action"
				});
			});
			
			
			
		});
	</script>
</body>
</html>
