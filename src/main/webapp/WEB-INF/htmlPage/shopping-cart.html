<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->

<title>爱购商城</title>

<!-- Bootstrap -->
<link href="../resources/plugins/bootstrap/css/bootstrap.min.css"
	rel="stylesheet">
<link href="../resources/my-css/shopping-cart.css" rel="stylesheet">
<link href="../resources/my-css/index.css" rel="stylesheet">
<link href="../resources/my-css/user-base.css" rel="stylesheet">
</head>
<body>
	<div class="page-header">
		<div class="container">
			<div class="row">
				<div class="col-md-2 heaer-menu">
					<a class="header-link" href="../login.html">请登录</a>&nbsp;&nbsp;&nbsp;
					<a class="header-link" href="../register.html">免费注册</a>
				</div>
				<div class="col-md-7"></div>
				<div class="col-md-1 heaer-menu">
					<div class="dropdown">
						<a id="dLabel1" data-target="#" href="#"
							data-toggle="dropdown" role="button" aria-haspopup="true"
							aria-expanded="false" class="header-link"> 我的爱购 <span
							class="caret"></span>
						</a>
						<ul class="dropdown-menu" aria-labelledby="dLabel1">
							<li><a class="link-hover">我的订单</a></li>
							<li><a class="link-hover">我的关注</a></li>
						</ul>
					</div>
				</div>
				<div class="col-md-1 heaer-menu">
					<div>
						<a href="shopping-cart.action" class="header-link">我的购物车 </a>
					</div>
				</div>
				<div class="col-md-1 heaer-menu">
					<div class="dropdown">
						<a id="dLabel3" data-target="#" href="http://example.com"
							data-toggle="dropdown" role="button" aria-haspopup="true"
							aria-expanded="false" class="header-link">联系客服 <span
							class="caret"></span>
						</a>
						<ul class="dropdown-menu" aria-labelledby="dLabel3">
							<li>028-12345678</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="container">
		<!-- 购物车主体隐藏区开始 -->
		<div>
			<div class="row cart-header">
				<div class="col-md-3 s-cart padding-lr0">
					<div class="col-md-6 padding-lr0">
						<a href="../index.html" class="thumbnail activity-link"> <img
							src="../resources/images/logo.png" class="logo">
						</a>
					</div>
					购物车
				</div>
			</div>
			<!-- 购物车列表开始 -->
			<div id="cartContainer">
				<div class="table-responsive cart-container">
				  <table class="table cart-table">
					   <thead>
					   		<tr>
					   			<th>
					   				<input type="checkbox" name="checkAll" checked=""/>
					   				全选
					   			</th>
					   			<th>
					   				商品
					   			</th>
					   			<th>
					   				单价
					   			</th>
					   			<th>
					   				数量
					   			</th>
					   			<th>
					   				小计
					   			</th>
					   			<th>
					   				库存
					   			</th>
					   			<th>
					   				操作
					   			</th>
					   		</tr>
					   </thead>
				   		<tbody id="cartList">
				   			<tr>
				   				<td><input type="checkbox"/></td>
				   				<td>
				   					<div class="media cart-commodity">
									  <div class="media-left media-middle">
									     <img class="media-object cart-image" src="file:///f:/register-right.png">
									  </div>
									  <div class="media-body comment">
									    <p>爱购联系保修，享受法定凭质保证书及爱购商城发票，可享受全国联保服务</p>
									    <div class="attribute_">
									    	<span>土豪版&nbsp;</span>
									    	<span>32寸&nbsp;</span>
									    </div>
									  </div>
									</div>
				   				</td>
				   				<td>￥320.00</td>
				   				<td>
									<div>
										<button type="button" class="btn btn-default btn-xs">-</button>
										<input type="text" class="form-control cart-input"/>
										<button type="button" class="btn btn-default btn-xs">+</button>
									</div>
				   				</td>
				   				<td><b>￥320.00</b></td>
				   				<td>
				   					<button type="button" class="btn btn-default btn-xs my-btn-1">删除</button>
				   					<button type="button" class="btn btn-default btn-xs my-btn-1">移入关注</button>
				   				</td>
				   			</tr>
				   			<tr>
				   				<td><input type="checkbox"/></td>
				   				<td>
				   					<div class="media cart-commodity">
									  <div class="media-left media-middle">
									     <img class="media-object cart-image" src="../resources/images/head-portrait.png">
									  </div>
									  <div class="media-body comment">
									    <p>爱购联系保修，享受法定凭质保证书及爱购商城发票，可享受全国联保服务</p>
									    <div class="attribute_">
									    	<span>土豪版&nbsp;</span>
									    	<span>32寸&nbsp;</span>
									    </div>
									  </div>
									</div>
				   				</td>
				   				<td>￥320.00</td>
				   				<td>
									<div>
										<button type="button" class="btn btn-default btn-xs">-</button>
										<input type="text" class="form-control cart-input"/>
										<button type="button" class="btn btn-default btn-xs">+</button>
									</div>
				   				</td>
				   				<td><b>￥320.00</b></td>
				   				<td>
				   					<button type="button" class="btn btn-default btn-xs my-btn-1">删除</button>
				   					<button type="button" class="btn btn-default btn-xs my-btn-1">移入关注</button>
				   				</td>
				   			</tr>
				   		</tbody>
				  </table>
				</div>
				<!-- 购物车列表结束 -->
				<div class="cart-operate col-md-12">
					<div class="col-md-3">
						<button type="button" class="btn btn-default btn-xs my-btn-1" id="deleteMore">删除选中商品</button>
						<button type="button" class="btn btn-default btn-xs my-btn-1">将选中商品移入收藏夹</button>
					</div>
					<div class="col-md-2 col-md-offset-6">
						总金额：<span class="total-money"><b id="totalPrice">￥1234.00</b></span>
					</div>
					<button type="button" class="btn btn-danger col-md-1" id="checkout">去结算</button>
				</div>
			</div>
		</div>
		<!-- 购物车主体隐藏区结束 -->
	</div>


	<hr />
	<div class="page-footer-body text-center">
		<ul class="footer-list">
			<li>关于我们</li>
			<li>联系我们</li>
			<li>亲情加盟</li>
			<li>商城社区</li>
			<li>我在中国</li>
			<li>友情链接</li>
		</ul>
	</div>
	<div class="page-copyright text-center">
		Copyright &copy; 2017 <strong>爱购商城i-go.shop</strong> 版权所有
	</div>
	
	<script src="../resources/plugins/jquery-2.2.4.min.js"></script>
	<script src="../resources/plugins/bootstrap/js/bootstrap.min.js"></script>
	<script src="../resources/scripts/my-utils.js"></script>
	<script src="../resources/scripts/my-ajax.js"></script>
	<script src="../resources/scripts/shopping-cart.js"></script>
	<script type="text/javascript"
		src="//at.alicdn.com/t/font_zcsipz08mj0b2o6r.js"></script>
	<script type="text/javascript">
		$(function(){
			
			//使全选按钮不选中
			$("#cartContainer input[name='checkAll']").prop("checked",false);
			
			//发送请求加载购物车数据
			$.ajax({
				data:"",
				dataType:"JSON",
				error:function() {
				
				},
				success:function(result){
					if(result.status === 1) {
						//清空列表
						$("#cartList").html("");
						var data = result.data;
						if(data===undefined || data===null || data.length<1) {
							$("#cartContainer").html("<div><img src='../resources/images/empty-shopping-cart.png' style='width:20%'></div><div><h4>购物车为空</h4></div>");
						} else {
							//清空列表
							$("#cartList").html("");
							for(var i=0; i<data.length; i++) {
								var $node = $("<tr>"+
								   				"<td><input type='checkbox'/ name='checkProject'></td>"+
								   				"<td>"+
								   					"<div class='media cart-commodity'>"+
													  "<div class='media-left media-middle'>"+
													     "<img class='media-object cart-image' src="+ data[i].mainUrl +">"+
													  "</div>"+
													  "<div class='media-body comment'>"+
													    "<p><b>"+ data[i].commTitle +"</b></p>"+
													    "<div class='attribute_'>"+
													    	"<span>"+ data[i].commBrand +"&nbsp;: </span>"+
													    	"<span>"+ data[i].prop1 +"&nbsp;</span>"+
													    	"<span>"+ data[i].prop2 +"&nbsp;</span>"+
													    "</div>"+
													  "</div>"+
													"</div>"+
								   				"</td>"+
								   				"<td class='unitPrice'>￥"+ data[i].price +"</td>"+
								   				"<td>"+
													"<div>"+
														"<button type='button' class='btn btn-default btn-xs amount-sub'>-</button>"+
														"<input type='text' class='form-control cart-input amount-input' value='"+ data[i].amount +"'/>"+
														"<button type='button' class='btn btn-default btn-xs amount-add'>+</button>"+
													"</div>"+
								   				"</td>"+
								   				"<td><b class='entityTotalPrice'>￥zx</b></td>"+
								   				"<td>"+ data[i].inventory +"件</td>"+
								   				"<td>"+
								   					"<button type='button' class='btn btn-default btn-xs my-btn-1 entity-delete'>删除</button>"+
								   					"<button type='button' class='btn btn-default btn-xs my-btn-1'>移入关注</button>"+
								   				"</td>"+
								   			"</tr>");
								$node.data("entityId",data[i].entityId);
								$node.data("commentityId",data[i].commentityId);
								console.log(data[i].entityId);
								$("#cartList").append($node);
								calculateEntityPrice($node);
							}
						}
					} else {
						$("#cartContainer").html("</div><div><h4>"+ result.info +"</h4></div>");
					}
				},
				type:"post",
				url:"../checkLogin/get-shopping-cart-entity.action"
			});
			
			//选择框单击事件
			$("#cartContainer").on("click","input[name='checkProject'],input[name='checkAll']",function(event){
				//事件源
				var $node = $(event.target);
				//所有项目的选择框
				var $checkProject = $("input[name='checkProject']");
				//全选选择框
				var $checkAll = $("input[name='checkAll']");
				if($node.attr("name") == "checkAll") {
					if($node.is(':checked')) {
						$checkProject.prop("checked",true);
					} else {
						$checkProject.prop("checked",false);
					}
				}
				if($node.attr("name") == "checkProject") {
					for(var i=0; i<$checkProject.length; i++) {
						if(!($checkProject.eq(i).is(':checked'))) {
							$checkAll.prop("checked", false);
							//重新计算总价
							calculateTotalPrice($("#cartList"));
							return;
						}
					}
					$checkAll.prop("checked", true);
				}
				//重新计算总价
				calculateTotalPrice($("#cartList"));
			});
			
			//数量输入框鼠标切入事件记录旧值
			$("#cartContainer").on("focus",".amount-input",function(event) {
				var $target = $(event.target);
				$target.data("oldNum",$target.val());
			});
			
			//数量按钮"- +"单击事件
			$("#cartContainer").on("click",".amount-sub,.amount-add",function(event){
				var $target = $(event.target);
				var entityId = $target.parents("tr").data("entityId");
				var $input; 
				if($target.text().trim() === "+") {
					$input = $target.prev();
					if($input.val().trim() === "") {
						return;
					}
					var num = parseInt($input.val());
					if(num>=9999) {
						$input.data("oldNum",num);
						return;
					}
					$input.data("oldNum",num);
					num = num + 1;
					$input.val("");
					changeAmount(num, entityId, $input);
				} else if($target.text().trim() === "-") {
					$input = $target.next();
					if($input.val().trim() === "") {
						return;
					}
					var num = parseInt($input.val());
					if(num<=1) {
						$input.data("oldNum",num);
						return;
					}
					$input.data("oldNum",num);
					num = num - 1;
					$input.val("");
					changeAmount(num, entityId, $input);
				}
			});
			
			//数量输入框值改变事件
			$("#cartContainer").on("change",".amount-input",function(event) {
				var $target = $(event.target);
				var entityId = $target.parents("tr").data("entityId");
				var value = $target.val().trim();
				if(!checkNum4(value)) {
					$target.val($target.data("oldNum"));
					return;
				}
				changeAmount(value, entityId, $target);
				console.log("ok");
			});
			
			//单击删除按钮删除单个商品
			$("#cartContainer").on("click",".entity-delete",function(event){
				var $tr = $(event.target).parents("tr");
				var entityId = $tr.data("entityId");
				if(entityId !== undefined) {
					$.ajax({
						data:{entityId:entityId},
						dataType:"json",
						error:function(){
							
						},
						success:function(result){
							if(result.status === 1) {
								$tr.remove();
								//重新计算总价
								calculateTotalPrice($("#cartList"));
							}
						},
						type:"post",
						url:"../checkLogin/deleteShoppingCart.action"
					});
				}
			});
			
			//删除选中商品事件
			$("#cartContainer").on("click","#deleteMore",function(){
				var $allChecked = $("#cartList input:checked[name='checkProject']");
				//console.log($allChecked);
				if($allChecked===undefined || $allChecked===null || $allChecked.length<1) {
					return;
				}
				var array = new Array($allChecked.length);
				for(var i=0; i<$allChecked.length; i++) {
					array[i] = $allChecked.eq(i).parents("tr").data("entityId");
				}
				//console.log(array);
				$.ajax({
					data:{entitiesId:array},
					dataType:"json",
					error:function(result){
						//console.log(result);
					},
					success:function(result){
						console.log(result);
						if(result.status === 1) {
							for(var i=0; i<$allChecked.length; i++) {
								$allChecked.eq(i).parents("tr").remove();
								//重新计算总价
								calculateTotalPrice($("#cartList"));
							}
						}
					},
					type:"post",
					url:"../checkLogin/deleteShoppingCarts.action"
				});
			});
			
			//点击结算
			$("#checkout").click(function(){
				var $allChecked = $("#cartList input:checked[name='checkProject']");
				//console.log($allChecked);
				if($allChecked===undefined || $allChecked===null || $allChecked.length<1) {
					return;
				}
				var array = new Array($allChecked.length);
				for(var i=0; i<$allChecked.length; i++) {
					array[i] = $allChecked.eq(i).parents("tr").data("commentityId") + "|" + $allChecked.eq(i).parents("tr").find(".amount-input").val().trim();
				}
				var param = window.btoa(array.join("&"));
				//var nowUrlPath = window.location.pathname;
				//应用路径
				//var appPath = nowUrlPath.substring(0, nowUrlPath.indexOf("/", 1));
				window.location.href = "order-commit.action?" + param;
			});
			
		});
	</script>
</body>
</html>
